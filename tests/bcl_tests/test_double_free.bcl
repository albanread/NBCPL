// Test program to verify double-free detection works
// This should trigger our new double-free metrics and error reporting

MANIFEST {
    HEAP_SIZE = 1000
}

LET START() BE {
    writef("Testing double-free detection...*n")

    // Test 1: Double-free a vector
    writef("Test 1: Double-free vector*n")
    LET vec = VEC 10
    writef("Allocated vector at %p*n", vec)

    FREEVEC(vec)
    writef("First free completed*n")

    // This should trigger double-free detection
    FREEVEC(vec)
    writef("Second free completed (this should not print if detection works)*n")

    // Test 2: Double-free a string
    writef("Test 2: Double-free string*n")
    LET str = VEC 20
    writef("Allocated string at %p*n", str)

    FREEVEC(str)
    writef("First string free completed*n")

    // This should trigger double-free detection
    FREEVEC(str)
    writef("Second string free completed (this should not print if detection works)*n")

    // Test 3: Double-free a list
    writef("Test 3: Double-free list*n")
    LET list = LIST(1, 2, 3)
    writef("Allocated list at %p*n", list)

    BCPL_FREE_LIST(list)
    writef("First list free completed*n")

    // This should trigger double-free detection
    BCPL_FREE_LIST(list)
    writef("Second list free completed (this should not print if detection works)*n")

    writef("Double-free test completed*n")
    BCPL_CHECK_AND_DISPLAY_ERRORS()
    FINISHbuild
}
